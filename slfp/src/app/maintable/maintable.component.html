<ng-container *ngIf="dataStore.isVersionInitialized()">
  <div class="maintable-container table table-sm">

    <!-- Fixed Columns -->
    <div id="fixedDivTable" class="fixed-coluumns-container">
      <div class="column1">
        <div class="sticky-header font-weight-bold">Jahr</div>
        <div class="cell">Steuervolumen</div>
        <div class="cell">Steueranlage</div>
        <div class="cell">Steuereinkommen</div>
        <div class="cell">Übrige Erträge</div>
        <div class="cell">Betriebsaufwände</div>
        <div class="cell">Übrige Aufwände</div>
        <div class="cell balance font-weight-bold">Überschuss/Fehlbetrag aus laufender Rechnung</div>
        <div class="cell ">Bestand flüssige Mittel aus ende Vorjahr (31.12.XXXX)</div>
        <div class="cell">Aufnahme / Rückzahlung Fremdkapital<span style="position: absolute;left: 303px; color: red">{{getForeignOK()}}</span></div>
        <div class="cell balance font-weight-bold">Total Liquiditätsbestand vor Abschreibungen</div>
        <div class="cell font-weight-bold">Investitionen und Abschreibungen</div>

        <!-- Investments -->
        <ng-container *ngFor="let investmentCategory of investmentCategories.getInvestmentCategories();trackBy:tracker">
          <div class="cell" (click)="toggleInvestmentCategory(investmentCategory)">
            <div class="row">
              <div class="col-11">
                <ng-container *ngIf='investmentCategory.investments.length > 0; else elseBlock'>
                  <span>
                    <span *ngIf="!investmentCategory.show" style="width: 12px">&#x2BC8;</span>
                    <span *ngIf="investmentCategory.show" style="width: 12px">&#x2BC6;</span>
                  </span>
                  <span style="margin-left: 10px">{{investmentCategory.name}}
                    <span class="text-right" style="right: -20px;position: absolute">
                      <b>{{investmentCategory.rate}}%</b>
                    </span>
                  </span>
                </ng-container>
                <ng-template #elseBlock>
                  <span class="investment-inactive">
                    <span style="width: 12px">&#x2BC8;</span>
                  </span>
                  <span class="investment-inactive" style="margin-left: 10px">{{investmentCategory.name}}
                    <span class="text-right" style="right: -20px;position: absolute">
                      <b>{{investmentCategory.rate}}%</b>
                    </span>
                  </span>
                </ng-template>
              </div>
            </div>
          </div>
          <ng-container *ngIf="investmentCategory.show">
            <div class="cell" *ngFor="let investment of investmentCategory.investments;trackBy:tracker">
              <span style="margin-left: 25px">{{investment.name}}    (Projekt-Nr: {{investment.projectNr}})</span>
            </div>
          </ng-container>
        </ng-container>

        <!-- HRM1 -->
        <div class="cell sticky-col1">
          <div class="row">
            <div class="col-8" style="padding-right: 0">
              <i>HRM1 Verwaltungsvermögen per 31.12.2017</i>
            </div>
            <div class="col-1" style="padding: 0;">
              <inlineedit [value]="dataStore.getInvestmentHRM1Container().yearCount" (valueChange)="changedHRM1Years($event)" [inThousand]="false" class="hrm1years"></inlineedit>
            </div>
            <div class="col-3" style="padding-left: 5px">
              <span class="ml-1">Jahre  =</span>
              <span class="text-right" style="right: 16px;position: absolute">
                  <b>{{dataStore.getInvestmentHRM1Container().rate | number:'0.0-2'}}%</b>
                </span>
            </div>
          </div>
        </div>

        <div class="cell">Wertberichtigung Abschreibungen (auch finanzpolitische Reserve)</div>
        <div class="cell balance font-weight-bold">Total Abschreibungen pro Jahr</div>
        <div class="cell balance font-weight-bold">Total Deinvestitionen pro Jahr</div>
        <div class="cell balance font-weight-bold">Total Liquiditätszufluss -Abfluss aus Rechnung (Cash flow)</div>
        <div class="cell balance font-weight-bold">Total Ausgaben Investitionen (Liquiditätsabfluss)</div>
        <div class="cell font-weight-bold">Subventionen</div>
        <div class="cell balance font-weight-bold">Liquiditätsbestand Total Ende Jahr</div>
        <div class="cell">Abzüglich zweckgebundene Reserve (finanzpolitische Reserve)</div>
        <div class="cell balance font-weight-bold">Verfügbare Liquidität</div>
      </div>
      <div class="column2">
        <div class="sticky-header font-weight-bold">Bestände Planung</div>
        <div class="cell sticky-col2">&#xa0;</div>
        <div class="cell sticky-col2">&#xa0;</div>
        <div class="cell sticky-col2">&#xa0;</div>
        <div class="cell sticky-col2">&#xa0;</div>
        <div class="cell sticky-col2">&#xa0;</div>
        <div class="cell sticky-col2">&#xa0;</div>
        <div class="cell sticky-col2 balance">&#xa0;</div>
        <div class="cell sticky-col2">&#xa0;</div>
        <div class="cell sticky-col2" data-toggle="popover" data-trigger="hover" data-placement="top"
             attr.data-content="Übertragen sie hier ihr Total an Fremdkapital per 31.12.{{dataStore.getActualVersion().yearFrom-1}}">
          <inlineedit [(value)]="calculator.getForeignContainer().foreignValue"></inlineedit>
        </div>
        <div class="cell sticky-col2 balance">&#xa0;</div>
        <div class="cell sticky-col2">
          <button type="button" class="btn btn-secondary btn-sm new-button" (click)="newInvestment()"
                  data-toggle="popover" data-trigger="hover" data-placement="top" data-content="neue Investition erfassen">+</button>
        </div>

        <!-- Investments -->
        <ng-container *ngFor="let investmentCategory of investmentCategories.getInvestmentCategories();trackBy:tracker">
          <div class="cell sticky-col2">&#xa0;</div>
          <ng-container *ngIf="investmentCategory.show">
            <div *ngFor="let investment of investmentCategory.investments;trackBy:tracker"
                 class="cell sticky-col2">
              <button type="button" class="btn btn-secondary btn-sm edit-button" (click)="editInvestment(investment)"
                      data-toggle="popover" data-trigger="hover" data-placement="top" data-content="Investition bearbeiten">&#x270E;</button>
            </div>
          </ng-container>
        </ng-container>

        <!-- HRM1 -->
        <div class="cell sticky-col2" data-toggle="popover" data-trigger="hover" data-placement="top" data-content="Übertragen sie hier ihr Total an Investitionen nach HRM1 per 31.12.2017">
          <inlineedit [(value)]="dataStore.getInvestmentHRM1Container().value"></inlineedit>
        </div>

        <div class="cell sticky-col2">&#xa0;</div>
        <div class="cell sticky-col2 balance">&#xa0;</div>
        <div class="cell sticky-col2 balance">&#xa0;</div>
        <div class="cell sticky-col2 balance">&#xa0;</div>
        <div class="cell sticky-col2 balance">&#xa0;</div>
        <div class="cell sticky-col2">&#xa0;</div>
        <div class="cell sticky-col2 balance">&#xa0;</div>
        <div class="cell sticky-col2">&#xa0;</div>
        <div class="cell sticky-col2 balance">&#xa0;</div>
      </div>
    </div>

    <!-- Scrollable Columns (infinite scroll) -->
    <cdk-virtual-scroll-viewport id="scrolledDivTable" orientation="horizontal" itemSize="100" class="scrollable-columns-container" minBufferPx="300" maxBufferPx="600">
      <div class="column" *cdkVirtualFor="let column of calculator.getDataColumns();let idx = index">
        <div class="sticky-header font-weight-bold text-center">
          {{column.year}}
        </div>
        <div class="cell">
          <inlineedit [value]="column.inoutcome.taxvolume" (valueChange)="changedTaxVolume($event, column.inoutcome)"></inlineedit>
        </div>
        <div class="cell">
          <inlineedit [value]="column.inoutcome.taxrate" (valueChange)="changedTaxrate($event, column.inoutcome)" [inThousand]="false"></inlineedit>
        </div>
        <div class="cell">
          <inlineedit [value]="column.inoutcome.income" (valueChange)="changedIncome($event, column.inoutcome)"></inlineedit>
        </div>
        <div class="cell">
          <inlineedit [value]="column.inoutcome.additionalIncome" (valueChange)="changedAddIncome($event, column.inoutcome)"></inlineedit>
        </div>
        <div class="cell">
          <inlineedit [value]="column.inoutcome.outcome" (valueChange)="changedOutcome($event, column.inoutcome)"></inlineedit>
        </div>
        <div class="cell">
          <inlineedit [value]="column.inoutcome.additionalOutcome" (valueChange)="changedAddOutcome($event, column.inoutcome)"></inlineedit>
        </div>
        <div class="cell text-right" [ngClass]="{'negative-value': column.balanceAfterOutcome<0}">
          {{column.balanceAfterOutcome | money }}
        </div>
        <div *ngIf="idx == 0" class="cell text-right table-info" data-toggle="popover" data-trigger="hover" data-placement="top" attr.data-content="Übertragen sie hier ihren Saldo Liquiditätsbestand per 31.12.{{column.year-1}}">
            <inlineedit [(value)]="dataStore.getLiquidityStart().liquidity"></inlineedit>
        </div>
        <div *ngIf="idx != 0" class="cell text-right" [ngClass]="{'negative-value': column.liquidityOfLastYear<0}">
          {{column.liquidityOfLastYear | money}}
        </div>
        <div class="cell text-right">
          <inlineedit [value]="column.foreignPayback.payback" (valueChange)="editPayback($event, column.foreignPayback)"></inlineedit>
        </div>
        <div class="cell text-right" [ngClass]="{'negative-value': column.balanceBeforeWriteoff<0}">
          {{column.balanceBeforeWriteoff | money}}
        </div>
        <div class="cell text-right">&nbsp;</div>

        <!-- Investments -->
        <ng-container *ngFor="let taxoffForRate of column.taxoffForRate;trackBy:tracker;let idx = index">
          <div class="cell text-right">{{ taxoffForRate.taxoffTotal | money }}</div>
          <ng-container *ngIf="investmentCategories.getInvestmentCategories()[idx].show">
            <div class="cell text-right" *ngFor="let taxoff of taxoffForRate.taxoffs;trackBy:tracker">{{ taxoff | money }}</div>
          </ng-container>
        </ng-container>

        <div class="cell text-right">
          {{ column.taxoffHRM1 | money }}
        </div>
        <div class="cell text-right">
          <inlineedit [(value)]="column.taxoffAdditional"></inlineedit>
        </div>
        <div class="cell text-right">
          {{ column.taxoffTotal | money }}
        </div>
        <div class="cell text-right"
          (mouseenter)="mouseEnterTT($event, column.deinvestment.tooltip, 'Deinvestitionen Jahr ' + column.deinvestment.year)"
          (mouseleave)="mouseLeaveTT()"
          (mouseout)="mouseLeaveTT()">{{column.deinvestment.investmentTotal | money}}
        </div>
        <div class="cell text-right" [ngClass]="{'negative-value': column.cashflow<0}">
          {{ column.cashflow | money }}
        </div>
        <div class="cell text-right" [ngClass]="{'negative-value': column.investment.investmentTotal<0}"
          (mouseenter)="mouseEnterTT($event, column.investment.tooltip, 'Investitionen Jahr ' + column.investment.year)"
          (mouseleave)="mouseLeaveTT()"
          (mouseout)="mouseLeaveTT()">{{column.investment.investmentTotal | money}}
        </div>
        <div class="cell text-right"
          (mouseenter)="mouseEnterTT($event, column.grant.tooltip, 'Subventionen Jahr ' + column.grant.year)"
          (mouseleave)="mouseLeaveTT()"
          (mouseout)="mouseLeaveTT()">{{column.grant.grantTotal | money}}
        </div>
        <div class="cell text-right font-weight-bold" [ngClass]="{'negative-value': column.balanceAfterInvestment<0, 'positive-value': column.balanceAfterInvestment>=0}">
          {{column.balanceAfterInvestment | money}}
        </div>
        <div class="cell">
          <inlineedit [(value)]="column.reserve"></inlineedit>
        </div>
        <div class="cell text-right" [ngClass]="{'negative-value': column.balanceAfterReserve<0, 'positive-value': column.balanceAfterReserve>=0}">
          {{column.balanceAfterReserve  | money}}
        </div>
      </div>
    </cdk-virtual-scroll-viewport>
  </div>

  <app-investment (closed)="onClosed()" [open]="showInvestment" [investment]="selectedInvestment"></app-investment>

  <div class="customalert floatalert alert alert-danger">
    <h4 class="alert-heading">Achtung!</h4>
    <p>{{alertText}}</p>
    <hr>
    <div class="text-center">
      <button type="submit" class="btn btn-secondary btn-sm alertbutton" (click)="closeAlert()">OK</button>
    </div>
  </div>

  <div class="customconfirm floatalert alert alert-danger">
    <h4 class="alert-heading">Achtung!</h4>
    <p>{{confirm.message}}</p>
    <hr>
    <div class="text-center">
      <button type="submit" class="btn btn-secondary btn-sm alertbutton mr-3" (click)="cancelConfirm()">Abbrechen</button>
      <button type="submit" class="btn btn-secondary btn-sm alertbutton" (click)="acceptConfirm()">OK</button>
    </div>
  </div>

  <div class="dyntooltip popover" role="tooltip">
    <button type="button" class="close" (click)="hideDynTooltip()">
      <span style="margin-right: 5px" aria-hidden="true">&times;</span>
    </button>
    <h4 class="popover-header">{{actualDynTooltipYear}}</h4>
    <div class="popover-body" [innerHTML]="actualDynTooltip | safeHtml">
    </div>
  </div>

</ng-container>
